name: Sign Release Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to sign (e.g., v0.0.2)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write # For Sigstore

jobs:
  sign:
    name: Sign with Sigstore
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.tag }}
    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ env.RELEASE_TAG }}
          fileName: '*.tar.gz'
          out-file-path: artifacts

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign artifacts
        run: |
          cd artifacts
          for file in *.tar.gz; do
            if [[ -f "$file" ]]; then
              echo "Signing $file..."
              cosign sign-blob --yes \
                --output-signature "${file}.sig" \
                --output-certificate "${file}.pem" \
                "$file"

              # Generate SHA256 checksum
              sha256sum "$file" > "${file}.sha256"
            fi
          done

      - name: Upload signatures to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            artifacts/*.sig
            artifacts/*.pem
            artifacts/*.sha256
          fail_on_unmatched_files: false

      - name: Verification instructions
        run: |
          TAG="${{ env.RELEASE_TAG }}"
          VERSION="${TAG#v}"

          echo "## Artifact Signing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release \`$TAG\` artifacts have been signed with Sigstore." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To verify the signed artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Download the artifact, signature, and certificate" >> $GITHUB_STEP_SUMMARY
          echo "gh release download $TAG -p 'projx-ui-*.tar.gz*'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify with cosign" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-blob \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --signature projx-ui-${VERSION}.tar.gz.sig \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate projx-ui-${VERSION}.tar.gz.pem \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp='https://github.com/aRustyDev/projx/.*' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer='https://token.actions.githubusercontent.com' \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  projx-ui-${VERSION}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify SHA256 checksum" >> $GITHUB_STEP_SUMMARY
          echo "sha256sum -c projx-ui-${VERSION}.tar.gz.sha256" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
